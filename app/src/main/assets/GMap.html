<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width" />
    <title>校園導覽</title>
    <style type="text/css">
      html,body {
        width: 99.5%;
        height: 99.5%;
        padding: 0;
        margin: 0px auto;
      }
      #container {
        width: 100%;
        height: 100%;
        margin: 0px auto;
        max-width: 720px;
      }
      #upperBlock{
        width: 100%;
        height: 57px;
        background-color: #f6f6f6;
      	background-image: -webkit-gradient(linear, left top, left bottom, from(#f6f6f6), to(#eae8e8));
      	background-image: -webkit-linear-gradient(top, #f6f6f6, #eae8e8);
      	background-image: -moz-linear-gradient(top, #f6f6f6, #eae8e8);
      	background-image: -ms-linear-gradient(top, #f6f6f6, #eae8e8);
      	background-image: -o-linear-gradient(top, #f6f6f6, #eae8e8);
      	background-image: linear-gradient(top, #f6f6f6, #eae8e8);
      	border-color: #dedede #bababa #aaa #bababa;
      	border-style: solid;
      	border-width: 1px;
        border-radius: 5px;
      	-webkit-box-shadow: 0 3px 3px rgba(255,255,255,.1), 0 3px 0 #bbb, 0 4px 0 #aaa, 0 5px 5px #444;
      	-moz-box-shadow: 0 3px 3px rgba(255,255,255,.1), 0 3px 0 #bbb, 0 4px 0 #aaa, 0 5px 5px #444;
      	box-shadow: 0 3px 3px rgba(255,255,255,.1), 0 3px 0 #bbb, 0 4px 0 #aaa, 0 5px 5px #444;
      }
      #innerBox{
        width: 100%;
        height: 100%;
        display: inline-block;
        position: relative;
      }
      .formWrapper{
        width: 240px;
        height: 55px;
        margin-left: 45px;
        display: inline-block;
      }
      .searchInput{
        width: 180px;
        height: 40px;
        padding-left: 40px;
        margin-top: 5px;
        border: 1px solid #CCC;
      	-webkit-box-shadow: 0 1px 1px #ddd inset, 0 1px 0 #FFF;
      	-moz-box-shadow: 0 1px 1px #ddd inset, 0 1px 0 #FFF;
      	box-shadow: 0 1px 1px #ddd inset, 0 1px 0 #FFF;
      	-webkit-border-radius: 3px;
      	-moz-border-radius: 3px;
      	border-radius: 3px;
        color: #999;
      	font: 16px Lucida Sans, Trebuchet MS, Tahoma, sans-serif;
        background-color: white;
        background-image: url('file:///android_asset/images/search_icon_gray.png');
        background-position: left;
        background-size: 40px;
        background-repeat: no-repeat;
      }
      .searchSubmit{
        display: none;
        width: 60px;
        height: 40px;
        margin: 2px;
        margin-top: 5px;
        padding-top: 10px;
        padding-bottom: 10px;
        background-color: #0483a0;
      	background-image: -webkit-gradient(linear, left top, left bottom, from(#31b2c3), to(#0483a0));
      	background-image: -webkit-linear-gradient(top, #31b2c3, #0483a0);
      	background-image: -moz-linear-gradient(top, #31b2c3, #0483a0);
      	background-image: -ms-linear-gradient(top, #31b2c3, #0483a0);
      	background-image: -o-linear-gradient(top, #31b2c3, #0483a0);
      	background-image: linear-gradient(top, #31b2c3, #0483a0);
      	border: 1px solid #00748f;
      	-moz-border-radius: 3px;
      	-webkit-border-radius: 3px;
      	border-radius: 3px;
      	-webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.3) inset, 0 1px 0 #FFF;
      	-moz-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.3) inset, 0 1px 0 #FFF;
      	box-shadow: 0 1px 0 rgba(255, 255, 255, 0.3) inset, 0 1px 0 #FFF;
      	color: #fafafa;
      	cursor: pointer;
        font: 15px Arial, Helvetica;
      }
      .hamButton{
        position: absolute;
        width: 40px;
        height: 30px;
        left: 0;
        top: 10px;
        background: transparent;
        border: 0;
        display: inline-block;
      }
      .refreshButton{
        position: absolute;
        width: 40px;
        height: 30px;
        right: 10px;
        top: 10px;
        background: transparent;
        border: 0;
        display: inline-block;
      }
      .nav{
        width: 30px;
        height: 30px;
      }
      #lowerBlock{
        display: flex;
        position: absolute;
        top: 60px;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0px auto;
        transition: 1s ease-in-out;
        z-index: 0;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      #detailBlock{
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 60px;
        background: rgb(238,238,238); /* Old browsers */
        background: -moz-linear-gradient(top, rgba(238,238,238,1) 0%, rgba(204,204,204,1) 100%); /* FF3.6-15 */
        background: -webkit-linear-gradient(top, rgba(238,238,238,1) 0%,rgba(204,204,204,1) 100%); /* Chrome10-25,Safari5.1-6 */
        background: linear-gradient(to bottom, rgba(238,238,238,1) 0%,rgba(204,204,204,1) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#eeeeee', endColorstr='#cccccc',GradientType=0 ); /* IE6-9 */
        transition: 1s ease-in-out;
      }
      #buttonBlock{
        width: 320px;
        height: 60px;
        margin: 0px auto;
      }
      .desButton{
        width: 100px;
        height: 40px;
        font-size:15px;
      	font-family:Arial;
      	border-radius:8px;
      	border:1px solid #84bbf3;
      	padding:9px 18px;
        margin: 10px 1px;
      	text-decoration:none;
      	background:-moz-linear-gradient( center top, #79bbff 5%, #378de5 100% );
      	background:-ms-linear-gradient( top, #79bbff 5%, #378de5 100% );
      	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#79bbff', endColorstr='#378de5');
      	background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #79bbff), color-stop(100%, #378de5) );
      	background-color:#79bbff;
      	color:#ffffff;
      	text-shadow:1px 1px 0px #528ecc;
       	box-shadow:inset 1px 1px 0px 0px #bbdaf7;
      }
      .markerName{
        font-size: 16px;
        font-weight: bold;
        font-family: 微軟正黑體, 標楷體, sans-serif;
      }
      .markerDesc{
        font-size: 13px;
        font-family: 微軟正黑體, 標楷體, sans-serif;
      }
      ul.ui-autocomplete {
        width: 150px;
        height: 50px;
        list-style:none;
        background-color: rgba(255, 255, 255, 0.9);
        color: black;
        -moz-border-radius: 5px;
        border-radius: 5px;
        overflow-y: scroll;
        overflow-x: hidden;
      }
      .ui-helper-hidden-accessible { position: absolute; left:-999em; }

      @media screen and (min-width: 480px) {
        .searchInput {
          width: 350px;
        }
        .searchSubmit {
          width: 80px;
          margin-left: 8px;
        }
      }

    </style>
    <script src="http://maps.google.com/maps/api/js?v=3&key=AIzaSyAOuz5xFsq3pIkk_kZxEXDMEr6UpzKnlro&libraries=geometry,places&callback=initMap"
            async defer></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script src="./destinations.js"></script>
    <script type="text/javascript">
        var map;
        var infoWindow;
        var imageBounds;
        var buidingAdminOverlay;
        var setTimer;
        var end ;
        var directionsService ;
        var directionsDisplay ;
        var oldlat;
        var oldlon;
		    var oldPlaceToGo;
        var destName; // info window
        var destLocation; // info window
        var destHowcome; // info window
        var destDescription; // 詳細資訊
        var destTransport; // 交通資訊
        var markers = [];

        function initMap(lat,lon) {
          end = new google.maps.LatLng(lat,lon);
          oldlat = lat;
          oldlon = lon;
          directionsService = new google.maps.DirectionsService();
          directionsDisplay = new google.maps.DirectionsRenderer();
          destDescription = "null";

          map = new google.maps.Map(document.getElementById('map'), {
            center: end,
            zoom: 19,
            disableDefaultUI: true
          });

          map.addListener('click', function() { //close the bottom info block when map onclick
            const lowerBlock = document.getElementById("lowerBlock");
            const detailBlock = document.getElementById("detailBlock");

            lowerBlock.style.bottom = 0;
            detailBlock.style.display = "none";

            infoWindow.close();
          });

          adminBound = { north: 24.945376, south: 24.944357, east: 121.371383, west: 121.370061 };
          businessBound = { north: 24.946057, south: 24.944992, east: 121.372648, west: 121.371168 };
          lawBound = { north: 24.944698, south: 24.943828, east: 121.373428, west: 121.372180 };
          publicBound = { north: 24.944039, south: 24.943117, east: 121.372226, west: 121.371065 };
          socialBound = { north: 24.944725, south: 24.943752, east: 121.370349, west: 121.368996 };
          libraryBound = { north: 24.943984, south: 24.943139, east: 121.370736, west: 121.369592 };
          humanBound = { north: 24.946432, south: 24.945617, east: 121.371593, west: 121.370676 };
          electricBound = { north: 24.943338, south: 24.942533, east: 121.371143, west: 121.370044 };

          buildingAdminOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/admin_build_try4.png', adminBound);
          buildingBusinessOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/business_build_try2.png', businessBound);
          buildingLawOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/law_building_try.png', lawBound);
          buildingPublicOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/public_build.png', publicBound);
          buildingSocialOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/social_build.png', socialBound);
          buildingLibraryOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/library_try.png', libraryBound);
          buildingHumanOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/human.png', humanBound);
          buildingElectricOverlay = new google.maps.GroundOverlay( 'file:///android_asset/images/electric_build.png', electricBound);

          buildingAdminOverlay.setMap(map);
          buildingBusinessOverlay.setMap(map);
          buildingLawOverlay.setMap(map);
          buildingPublicOverlay.setMap(map);
          buildingSocialOverlay.setMap(map);
          buildingLibraryOverlay.setMap(map);
          buildingHumanOverlay.setMap(map);
          buildingElectricOverlay.setMap(map);
        }

        function clearMarkers(){
          for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
          }
        }

        function makeMarker( position, icon, title ) {
           var marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: icon,
            title: title
           });
           markers.push(marker);

           var endIcon = 'http://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=glyphish_target|ed5190';

           if (icon.url === endIcon) { //start icon should not have click event
             var hint = '<h2 style="font-size:16px">小提示</h2><br />'+
             '<span>點擊marker可以查看更多資訊</span>';

             infoWindow = new google.maps.InfoWindow({
               map: map,
               content: hint,
             });
             //hint for user, if it's necessary
             infoWindow.open(map, marker);
             setTimer = setTimeout( function(){
                infoWindow.close();
             }, '6000');

             var content =  '<span class="markerName">' + destName + '</span><br />' +
             '<span class="markerDesc">' + destLocation + '<br /><br />' + '-----如何來這裡?-----<br />' +
             destHowcome + '</span>';

             bindInfoWindow(marker, map, infoWindow, content);
           }
        }

        function direct(lat,lon){
      		directionsDisplay.setMap(map);
          directionsDisplay.setOptions({ suppressMarkers: true });
          oldlat = lat;
          oldlon = lon;
          var icons = {
            start: new google.maps.MarkerImage(
              // URL
              'http://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=glyphish_runner|5190ED'
              /*,
              // (width,height)
              new google.maps.Size( 300, 300 ),
              // The origin point (x,y)
              new google.maps.Point( 0, 0 ),
              // The anchor point (x,y)
              new google.maps.Point( 10, 35 )//2232*/
            ),
            end: new google.maps.MarkerImage(
              // URL
              'http://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=glyphish_target|ed5190'
              /*,
              // (width,height)
              new google.maps.Size( 44, 32 ),
              // The origin point (x,y)
              new google.maps.Point( 0, 0 ),
              // The anchor point (x,y)
              new google.maps.Point( 10, 35 )*/
            )
          };

          var request = {
         				origin: new google.maps.LatLng(lat,lon),
         				destination: end,
         				travelMode: google.maps.TravelMode.WALKING
          };

          directionsService.route(request, function(result, status){
          	if (status == google.maps.DirectionsStatus.OK){
         		  directionsDisplay.setDirections(result);
              var leg = result.routes[ 0 ].legs[ 0 ];
              clearMarkers();
              makeMarker( leg.start_location, icons.start, "title" );
              makeMarker( leg.end_location, icons.end, 'title' );
            }
          });
      	}

        function findPlaceToDirect(){
          const placeToGo = document.getElementById("tags").value;
          const submitButton = document.getElementById("submit");
          const refreshButton = document.getElementById("refresh");
          const refreshImg = document.getElementById("refreshImg");
          const getFormWidth = document.getElementById("form").style.width;

          var hasInput = placeToGo === '' ? false : true ;

          if (hasInput) {
            // download from database and do something here
            downloadUrl("http://dmcl.twbbs.org/NTPU_guidance/search_sql.php", function(data) {
              var xml = data.responseXML;
              var markers = xml.documentElement.getElementsByTagName("marker");
              //grab all the data here
              for (var i = 0; i < markers.length; i++) {
                var name = markers[i].getAttribute("name");
                var location = markers[i].getAttribute("location");
                var point = new google.maps.LatLng(parseFloat(markers[i].getAttribute("latitude")),parseFloat(markers[i].getAttribute("longitude")));
                var description = markers[i].getAttribute("description");
                var howcome = markers[i].getAttribute("howcome");
                var transport = markers[i].getAttribute("transport");

                if (i === markers.length - 1) { // the last data in db
                  if (name === placeToGo) {
                    //send data location to direct function
                    end = point;
                    destName = name; //info window
                    destLocation = location;//info window
                    destHowcome = howcome;//info window
                    destDescription = description;
                    destTransport = transport;
                    direct(oldlat,oldlon);
                    Android.setStartUse();
					          oldPlaceToGo = placeToGo;
					          Android.GetOldplace(oldPlaceToGo);
                    //Android.GetLonLat(latitude,longitude);

                    submitButton.style.display = "none";
                    refreshButton.style.display = "inline-block";
                    refreshImg.style.display = "inline-block";
                    getFormWidth.style.width = "240px";

                    break;
                  } else { //can't find
                    alert("找不到您要去的地點!");
                    submitButton.style.display = "inline-block";
                    refreshButton.style.display = "none";
                    refreshImg.style.display = "none";
                    getFormWidth.style.width = "300px";
                  }
                } else {
                  if (name === placeToGo) { //find place to go
                     //send data location to direct function
                    end = point;
                    destName = name;//info window
                    destLocation = location;//info window
                    destHowcome = howcome;//info window
                    destDescription = description;
                    destTransport = transport;
                    direct(oldlat,oldlon);
                    Android.setStartUse();
					          oldPlaceToGo = placeToGo;
					          Android.GetOldplace(oldPlaceToGo);
                    //Android.GetLonLat(latitude,longitude);

                    submitButton.style.display = "none";
                    refreshButton.style.display = "inline-block";
                    refreshImg.style.display = "inline-block";
                    getFormWidth.style.width = "240px";

                    break;
                  }
                }
              }
            });
          } else { // no input
            // then do nothing
          }
        }

        function showStart() {
          const submitButton = document.getElementById("submit");
          const refreshButton = document.getElementById("refresh");
          const refreshImg = document.getElementById("refreshImg");
          const getSearchValue = document.getElementById("tags").value;
          const getFormWidth = document.getElementById("form");

          if (getSearchValue === '') {
            submitButton.style.display = "none";
            refreshButton.style.display = "inline-block";
            refreshImg.style.display = "inline-block";
            getFormWidth.style.width = "240px";
          } else {
            submitButton.style.display = "inline-block";
            refreshButton.style.display = "none";
            refreshImg.style.display = "none";
            getFormWidth.style.width = "100%";
          }
        }

        function listTrigger() {
          //ham button click
          Android.htmlOpendrawer();
        }

        function refreshTrigger() {
          //refresh button click
        }

        function usingMap() {
          const lowerBlock = document.getElementById("lowerBlock");

          lowerBlock.style.zIndex = "0";
        }

        function mapBlur() {
          const lowerBlock = document.getElementById("lowerBlock");

          lowerBlock.style.zIndex = "-1";
        }

        function showTraffic() {
          //show traffic information
          Android.OnTransportClick();
        }

        function showFloorPlan() {
          //show floor plan
		      Android.getWhereToGo(oldPlaceToGo);
        }

        function showDetail() {
          Android.OnInfoClick(oldPlaceToGo);
          //show destination detail
        }

        function drawerNavigation(destination) {
          //for drawer navigation
          const placeToGo = destination; //get destination string

          downloadUrl("http://dmcl.twbbs.org/NTPU_guidance/search_sql.php", function(data) {
            var xml = data.responseXML;
            var markers = xml.documentElement.getElementsByTagName("marker");
            //grab all the data here
            for (var i = 0; i < markers.length; i++) {
              var name = markers[i].getAttribute("name");
              var location = markers[i].getAttribute("location");
              var point = new google.maps.LatLng(parseFloat(markers[i].getAttribute("latitude")),parseFloat(markers[i].getAttribute("longitude")));
              var description = markers[i].getAttribute("description");
              var howcome = markers[i].getAttribute("howcome");
              var transport = markers[i].getAttribute("transport");

              if (i === markers.length - 1) { // the last data in db
                if (name === placeToGo) { //find place to go
                  end = point; // assign it to end
                  destName = name;//info window
                  destLocation = location;//info window
                  destHowcome = howcome;//info window
                  destDescription = description;
                  destTransport = transport;
                  direct(oldlat,oldlon);
				          oldPlaceToGo = placeToGo;
				          Android.GetOldplace(oldPlaceToGo);
                  //add some action on android here

                  break;
                } else { //can't find
                  alert("查不到正確的地點!!");
                  //add some action on android here
                }
              } else {
                if (name === placeToGo) { //find place to go
                  end = point;
                  destName = name;//info window
                  destLocation = location;//info window
                  destHowcome = howcome;//info window
                  destDescription = description;
                  destTransport = transport;
                  direct(oldlat,oldlon);
				          oldPlaceToGo = placeToGo;
				          Android.GetOldplace(oldPlaceToGo);
                  //add some action on android here

                  break;
                }
              }
            }
          });
        }
        //bind infowindow on marker
        function bindInfoWindow(marker, map, infoWindow, desc){
          google.maps.event.addListener(marker, 'click', function() {
            clearTimeout(setTimer);
            infoWindow.setContent(desc); //set description on marker
            infoWindow.open(map, marker);

            const lowerBlock = document.getElementById("lowerBlock");
            const detailBlock = document.getElementById("detailBlock");

            lowerBlock.style.bottom = "60px";
            detailBlock.style.display = "block";
          });
        }
        //for downloading database
        function downloadUrl(url, callback) {
            var request = window.ActiveXObject ?
            new ActiveXObject('Microsoft.XMLHTTP') :
            new XMLHttpRequest;
            request.onreadystatechange = function() {
                if (request.readyState == 4) {
                    request.onreadystatechange = doNothing;
                    callback(request, request.status);
                }
            };
            request.open('GET', url, true);
            request.send(null);
        }
        function doNothing() {
        }
        //auto complete for searching tags
        $( function() {
          var availableTags = tags; //tags maintained in destination.js
          $( "#tags" ).autocomplete({
            source: function(request, response) {
              var results = $.ui.autocomplete.filter(availableTags, request.term); //filter tags

              response(results.slice(0, 10)); //only display 10 results
            },
            select: function( event, ui) {
              $("#tags").val(ui.item.label);
              return false;
            }
          });
        });
    </script>
</head>
<!--program start on initMap() function-->
<body >
  <div id="container">
    <div id="upperBlock">
      <div id="innerBox">
        <button class="hamButton" onclick="listTrigger()">
          <img class="nav" src="file:///android_asset/images/ic_action_ham.png"/>
        </button>
        <form id="form" class="formWrapper" action="javascript:findPlaceToDirect();">
          <input id="tags" class="searchInput" type="text" name="search" placeholder="想去哪裡?"
            onkeyup="showStart()"
            onblur="usingMap()"
            onclick="mapBlur()"
          >
          <input id="submit" class="searchSubmit" type="submit" name="submit" value="出發">
        </form>
        <button id="refresh" class="refreshButton" onclick="refreshTrigger()">
          <img id="refreshImg" class="nav" src="file:///android_asset/images/ic_action_refresh.png"/>
        </button>
      </div>
    </div>
    <div id="lowerBlock">
      <div id="map"></div>
    </div>
    <div id="detailBlock">
      <div id="buttonBlock">
        <button class="desButton" onclick="showTraffic()">交通資訊</button>
        <button class="desButton" onclick="showFloorPlan()">平面圖</button>
        <button class="desButton" onclick="showDetail()">詳細資訊</button>
      </div>
    </div>
  </div>
</body>
</html>
